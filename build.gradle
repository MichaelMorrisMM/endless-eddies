/*
 * This file was generated by the Gradle 'init' task.
 *
 * This is a general purpose Gradle build.
 * Learn how to create Gradle builds at https://guides.gradle.org/creating-new-gradle-builds/
 */

plugins {
    id "com.moowork.node" version "1.2.0"
}

apply plugin: 'java'

def deployPath = serverDir + "/webapps/" + rootProject.name
def javaDestPath = deployPath + "/WEB-INF/classes"
def serverLibPath = serverDir + "/lib"

dependencies {
    compile fileTree(dir: "libs", include: "**/*.jar")
}

task deployAll(type: GradleBuild) {
    tasks = ["deployJava", "deployAngular"]
}

task cleanAll(type: GradleBuild) {
    tasks = ["clean", "cleanDeployment", "cleanAngular"]
}

task cleanProject(type: GradleBuild) {
    tasks = ["clean", "cleanAngular"]
}

task cleanDeployment(type: Delete) {
    delete new File(deployPath)
}

task cleanAngular(type: Delete) {
    delete "dist"
}

// TODO Optimize to only move if not already present
task deployLibs(type: Copy) {
    from "libs"
    into serverLibPath
    include "**/*.jar"
}

task seedDeployment {
    def deploy = new File(deployPath)
    if (!deploy.exists()) {
        deploy.mkdirs()
    }
}

task seedJava {
    def javaDest = new File(javaDestPath)
    if (!javaDest.exists()) {
        javaDest.mkdirs()
    }
}

task deployJava(type: Copy) {
    from sourceSets.main.output.classesDirs
    into javaDestPath
}
deployJava.dependsOn deployLibs, seedJava, classes

task buildAngular(type: Exec) {
    if (System.getProperty("os.name").toUpperCase().contains("WINDOWS")) {
        commandLine "ng.cmd", "build", "--base-href=/endless-eddies/"
    } else {
        commandLine "ng", "build", "--base-href=/endless-eddies/"
    }
}
buildAngular.dependsOn npmInstall

task deployAngular(type: Copy) {
    from "dist"
    into deployPath
}
deployAngular.dependsOn seedDeployment, buildAngular